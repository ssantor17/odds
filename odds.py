from bs4 import BeautifulSoup
import urllib3
import pandas as pd
import numpy as np
import random
import sys

# pd.set_option('expand_frame_repr',False)
# sys.setrecursionlimit(2500)

#######################
##  For URL scraping ##
#######################

url='http://www.covers.com/odds/football/nfl-spreads.aspx'
soup = BeautifulSoup(urllib3.PoolManager().request('GET',url).data,'html.parser')

card = soup.findAll("div", {"id" : "odds_teams"})

games=0
for game in card:
	games += 1

core=pd.DataFrame(columns = ['game_id','away','home','spread','ou','hist_url'], index = range(games))

spreads = soup.findAll('a', href=True)

count=0
for element in spreads:
	count += 1

game_spread=0
game_ou=0

for element in range(count):
	if (spreads[element]['href'] == 'http://www.covers.com/WhereToPlay/SportsbookRedirect?sportsbookId=782&location=Covers Featured Odds'):
		if(spreads[element].find('div', {'class' : 'line_top'}) is not None):
	
			core.iat[game_ou,4] = spreads[element].find('div', {'class' : 'line_top'}).string.strip()

			game_ou += 1

		if(spreads[element].find('div', {'class' : 'offshore'}) is not None):
	
			core.iat[game_spread,3] = spreads[element].find('div', {'class' : 'offshore'}).string.strip()

			game_spread += 1


for game in range(games):

	core.iat[game,0] = game + 1

	if (card[game].find('div', {"class" : "team_away"}).find('strong').string.strip() is not None):

 		core.iat[game,1] = card[game].find('div', {"class" : "team_away"}).find('strong').string.strip()

	if (card[game].find('div', {"class" : "team_home"}).find('strong').string.string.replace("@","").strip() is not None):

 		core.iat[game,2] = card[game].find('div', {"class" : "team_home"}).find('strong').string.replace("@","").strip()


# ####################################################################################################################

count=0
for element in soup.findAll('td',{'class': 'odds_table_row'}):
	count +=1


game=0
for element in range(count):

	if (soup.findAll('td',{'class': 'odds_table_row'})[element].findAll('a', href=True)):
		core.iat[game,5] = 'http://www.covers.com' + soup.findAll('td',{'class': 'odds_table_row'})[element].findAll('a', href=True)[1]['href']
		game += 1

		
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################


for game in range(games):

	url2=core.iat[game,5]
	soup2 = BeautifulSoup(urllib3.PoolManager().request('GET',url2).data,'html.parser')

	chunks = soup2.find('table', {'id' : 'bodyContentPlaceHolder_ucLineHistory_tblLineHistory'}).findAll('tr')

	numchunks=0
	for chunk in chunks:
		numchunks += 1


	###############################################################################################


	for chunk in range(numchunks):

		if (chunk == 0):
			chunk += 1
			continue

		if (chunks[chunk]['bgcolor'] == '#ECECE4'):
			break

		chunk += 1


	temp = pd.DataFrame(columns=['game_id','time','spread','ou','move_num'] , index=range(chunk-1))
	#moves = pd.DataFrame(columns=['game_id','time','spread','ou','move_num'] , index=range(chunk-1))

	###############################################################################################

	for chunk in range(numchunks):

		if (chunk == 0):
			chunk += 1
			continue

		if (chunks[chunk]['bgcolor'] == '#ECECE4'):
			break

		temp.iat[chunk-1,1] = chunks[chunk].findAll('td', {'class' : 'smtext2'} )[0].string.strip()
		temp.iat[chunk-1,2] = chunks[chunk].findAll('td', {'class' : 'smtext2'} )[1].string.strip()
		temp.iat[chunk-1,3] = chunks[chunk].findAll('td', {'class' : 'smtext2'} )[2].string.strip()
		temp.iat[chunk-1,4] = chunk-1

		chunk += 1

	temp['game_id'] = game + 1

	if (game == 0):
		moves = temp
	else:
		moves = pd.concat([moves,temp])


###################################################################################################################################################


core.to_pickle("games.pk1") 
moves.to_pickle("line_moves.pk1")


# core = pd.read_pickle('line_moves.pk1')
# moves = pd.read_pickle('line_moves.pk1')
